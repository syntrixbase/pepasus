#!/usr/bin/env bash
# Pre-commit hook: run typecheck and tests before committing.
set -euo pipefail

# Prevent direct commits to main branch
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "detached")
if [ "$BRANCH" = "main" ]; then
  echo "‚ùå Direct commits to main branch are not allowed!"
  echo "   Please create a feature branch instead:"
  echo "   git checkout -b feature/your-feature-name"
  exit 1
fi

echo "üîç Running typecheck..."
bunx tsc --noEmit

echo "üß™ Running tests..."
TEST_OUTPUT=$(PEGASUS_LOG_LEVEL=silent bun test tests/ 2>&1)
TEST_EXIT=$?
echo "$TEST_OUTPUT"

if [ $TEST_EXIT -ne 0 ]; then
  echo "‚ùå Tests failed!"
  exit 1
fi

if echo "$TEST_OUTPUT" | grep -Eq "^[[:space:]]+[0-9]+ skip"; then
  SKIP_COUNT=$(echo "$TEST_OUTPUT" | grep -oE "[0-9]+ skip" | grep -oE "^[0-9]+")
  echo "‚ùå ${SKIP_COUNT} skipped test(s) detected! No tests should be skipped."
  echo "   Remove .skip() or .todo() from tests before committing."
  exit 1
fi

echo "‚úÖ All checks passed."
